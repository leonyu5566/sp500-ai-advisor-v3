<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>標普500 AI 策略顧問系統</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.autotable.min.js"></script>

    <!-- Google Fonts for typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f8fafc;
        }
        .sidebar-link {
            display: flex; align-items: center; padding: 0.75rem 1rem;
            border-radius: 0.5rem; transition: background-color 0.2s, color 0.2s;
            color: #4b5563;
        }
        .sidebar-link:hover { background-color: #e5e7eb; color: #111827; }
        .sidebar-link.active { background-color: #3b82f6; color: white; font-weight: 500; }
        
        /* Mobile nav styles */
        .mobile-nav-link {
            display: flex; flex-direction: column; align-items: center;
            padding: 0.5rem; border-radius: 0.5rem;
            transition: background-color 0.2s, color 0.2s;
            color: #4b5563; flex-grow: 1; justify-content: center;
        }
        .mobile-nav-link.active {
            color: #3b82f6;
        }

        .content-page { display: none; }
        .content-page.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        .card {
            background-color: white; border-radius: 0.75rem;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        }
        .indicator-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out, border-color 0.2s ease-in-out;
            cursor: pointer;
        }
        .indicator-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            border-color: #60a5fa; /* blue-400 */
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .chat-bubble-user {
            background-color: #3b82f6; color: white;
            border-radius: 1rem 1rem 0.25rem 1rem;
        }
        .chat-bubble-bot {
            background-color: #e5e7eb; color: #1f2937;
            border-radius: 1rem 1rem 1rem 0.25rem;
        }
        .prose ul > li::before { background-color: #6b7280; }
        
        /* Modal and Notification styles */
        .modal-overlay, .notification-container {
            position: fixed;
            display: flex;
            justify-content: center;
            z-index: 50;
            transition: opacity 0.3s ease;
        }
        .modal-overlay {
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            align-items: center;
            opacity: 0;
            pointer-events: none;
        }
        .modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            background: white; padding: 1.5rem; border-radius: 0.75rem;
            width: 90%; max-width: 56rem;
            transform: scale(0.95); transition: transform 0.3s ease;
        }
        .modal-overlay.active .modal-content {
            transform: scale(1);
        }
        .notification-container {
            bottom: 1.5rem;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            pointer-events: none;
        }
        .notification-container.show {
            opacity: 1;
        }
        .notification {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .notification.success { background-color: #22c55e; } /* green-500 */
        .notification.error { background-color: #ef4444; } /* red-500 */
        .notification.info { background-color: #3b82f6; } /* blue-500 */
    </style>
</head>
<body class="bg-gray-100">

    
    <aside class="hidden lg:flex lg:flex-col lg:w-64 lg:fixed lg:inset-y-0 z-50 bg-white border-r border-gray-200 p-4">
        <div class="flex items-center gap-3 mb-8">
            <div class="bg-blue-500 p-2 rounded-lg flex-shrink-0">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>
            </div>
            <div>
                <h1 class="text-lg font-bold text-gray-900 leading-tight">標普500</h1>
                <p class="text-sm text-gray-500 leading-tight">AI 策略顧問</p>
            </div>
        </div>
        <nav class="flex flex-col gap-2">
            <a href="#dashboard" class="nav-link sidebar-link active">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" /></svg>
                儀表板
            </a>
            <a href="#qa-robot" class="nav-link sidebar-link">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor"><path d="M10 2a6 6 0 00-6 6v3.586l-1.707 1.707A1 1 0 003 15v1a1 1 0 001 1h12a1 1 0 001-1v-1a1 1 0 00-.293-.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z" /></svg>
                智能策略問答
            </a>
            <a href="#monthly-forecast" class="nav-link sidebar-link">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>
                模型預測
            </a>
        </nav>
        <div class="mt-auto border-t pt-4">
             <a href="#model-settings" class="nav-link sidebar-link text-sm">模型設定</a>
             <a href="#data-management" class="nav-link sidebar-link text-sm">數據管理</a>
             <a href="#reports" class="nav-link sidebar-link text-sm">報告中心</a>
        </div>
    </aside>

    
    <header class="lg:hidden fixed top-0 left-0 right-0 z-40 bg-white border-b border-gray-200">
        <div class="flex justify-around items-center p-1">
            <a href="#dashboard" class="nav-link mobile-nav-link active">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" /></svg>
                <span class="text-xs mt-1">儀表板</span>
            </a>
            <a href="#qa-robot" class="nav-link mobile-nav-link">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M10 2a6 6 0 00-6 6v3.586l-1.707 1.707A1 1 0 003 15v1a1 1 0 001 1h12a1 1 0 001-1v-1a1 1 0 00-.293-.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z" /></svg>
                <span class="text-xs mt-1">智能問答</span>
            </a>
            <a href="#monthly-forecast" class="nav-link mobile-nav-link">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>
                <span class="text-xs mt-1">模型預測</span>
            </a>
        </div>
    </header>

    
    <div class="lg:pl-64 w-full">
        <main class="pt-20 pb-20 lg:pt-8 lg:pb-8 px-4 md:px-8">
            
            <div id="dashboard" class="content-page active">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">儀表板</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                    <div class="card p-6 flex flex-col justify-center items-center bg-green-50 border-2 border-green-200">
                        <h3 class="text-gray-500 text-sm font-medium">市場宏觀信號</h3>
                        <div class="flex items-center gap-2 mt-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13a1 1 0 102 0V9.414l1.293 1.293a1 1 0 001.414-1.414z" clip-rule="evenodd" /></svg>
                            <p class="text-3xl font-bold text-green-600">偏多</p>
                        </div>
                        <p class="text-xs text-gray-400 mt-1">S&P 500 模型預測趨勢向上</p>
                    </div>
                    <div class="card p-6 bg-blue-600 text-white shadow-lg overflow-hidden relative flex flex-col">
                        <div class="absolute -right-8 -bottom-8 bg-white/10 rounded-full h-32 w-32"></div>
                        <div class="absolute -left-4 -top-10 bg-white/10 rounded-full h-24 w-24"></div>
                        <div class="relative z-10 flex flex-col flex-grow">
                            <h3 class="font-medium opacity-80 text-sm">當前建議策略</h3>
                            <p class="text-3xl font-bold mt-2">增持成長型資產</p>
                            <div class="mt-4 pt-3 border-t border-white/20 flex-grow flex flex-col justify-end">
                                <div>
                                    <p class="text-xs font-semibold">關注領域：</p>
                                    <div class="flex flex-wrap gap-2 mt-2">
                                        <span class="bg-white/20 text-xs px-2 py-1 rounded-full">高 Beta</span>
                                        <span class="bg-white/20 text-xs px-2 py-1 rounded-full">科技</span>
                                        <span class="bg-white/20 text-xs px-2 py-1 rounded-full">半導體</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card p-6 flex flex-col">
                        <div class="flex-shrink-0 flex justify-between items-center">
                            <h3 class="text-gray-500 text-sm font-medium">市場焦點 (AI 快篩)</h3>
                            <button id="generate-summary-btn" class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full hover:bg-blue-200 transition disabled:bg-gray-200 disabled:cursor-not-allowed">✨ 生成今日分析</button>
                        </div>
                        <div class="mt-2 flex-1 relative">
                            <div id="market-focus-content" class="absolute inset-0 overflow-y-auto pr-2">
                                <p class="text-sm font-bold text-gray-800">分析師上調半導體行業評級</p>
                                <p class="text-xs text-gray-400 mt-1">來源：MarketWatch | 正面信號</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card p-6 mb-6"><h3 class="text-xl font-bold mb-4">策略回測績效</h3><div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 text-center"><div><p class="text-sm text-gray-500">AI 模型策略</p><p class="font-bold text-lg text-green-600">Sharpe: 1.25</p></div><div><p class="text-sm text-gray-500">買入並持有 S&P 500</p><p class="font-bold text-lg">Sharpe: 0.85</p></div><div><p class="text-sm text-gray-500">模型擇時策略</p><p class="font-bold text-lg">Sharpe: 1.05</p></div></div><div class="h-80"><canvas id="backtestChart"></canvas></div></div>
                <div class="mb-6"><h3 class="text-xl font-bold text-gray-800 mb-4">智能警示</h3><div class="card p-4 space-y-3"><div class="flex items-start gap-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-500 flex-shrink-0 mt-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.636-1.21 2.37-1.21 3.006 0l5.429 10.323c.63 1.198-.28 2.701-1.653 2.701H4.48c-1.373 0-2.283-1.503-1.653-2.701l5.43-10.323zM9 13a1 1 0 112 0v1a1 1 0 11-2 0v-1zm1-4a1 1 0 00-1 1v2a1 1 0 102 0V9a1 1 0 00-1-1z" clip-rule="evenodd" /></svg><div><p class="font-bold text-sm">市場信號轉變：偏多 -> 中性</p><p class="text-xs text-gray-600">S&P 500 預測幅度收窄，VIX 指數小幅上升。建議檢視您的成長型資產配置，可考慮部分獲利了結。</p></div></div></div></div>
                <div><h3 class="text-xl font-bold text-gray-800 mb-4">關鍵經濟指標一覽</h3><div id="indicator-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4"></div></div>
            </div>
            <div id="qa-robot" class="content-page">
                 <h2 class="text-3xl font-bold text-gray-800 mb-6">智能策略問答 (✨ Gemini 驅動)</h2>
                <div class="card h-[75vh] flex flex-col">
                    <div id="chat-window" class="flex-1 p-6 overflow-y-auto space-y-4"></div>
                    <div class="p-4 border-t border-gray-200">
                        <p class="text-sm text-gray-600 mb-2">或試試問我 (為長期投資人分析)：</p>
                        <div id="quick-questions-container" class="flex flex-wrap gap-2">
                            <button class="quick-question-btn bg-gray-100 text-gray-700 text-sm px-3 py-1.5 rounded-full hover:bg-gray-200 transition">根據目前信號，推薦我一些標的</button>
                            <button class="quick-question-btn bg-gray-100 text-gray-700 text-sm px-3 py-1.5 rounded-full hover:bg-gray-200 transition">為什麼現在要選科技股？</button>
                            <button class="quick-question-btn bg-gray-100 text-gray-700 text-sm px-3 py-1.5 rounded-full hover:bg-gray-200 transition">半導體產業前景如何？</button>
                        </div>
                    </div>
                    <div class="p-4 border-t border-gray-200 bg-white">
                        <form id="chat-form" class="flex items-center gap-4">
                            <input type="text" id="chat-input" placeholder="輸入關於長期投資的問題..." class="form-input w-full p-2" autocomplete="off">
                            <button type="submit" class="bg-blue-500 text-white rounded-full p-3 hover:bg-blue-600 transition">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            <div id="monthly-forecast" class="content-page">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">模型預測工具</h2>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1 card p-6">
                        <h3 class="text-xl font-bold mb-4">預測參數</h3>
                        <form id="predictionForm" class="space-y-3 max-h-[65vh] overflow-y-auto pr-2"></form>
                    </div>
                    <div class="lg:col-span-2 card p-6">
                        <div class="flex flex-col md:flex-row items-center justify-between gap-4 mb-6"><h3 class="text-xl font-bold">未來走勢預測</h3><div class="flex items-center gap-2"><label for="monthsToForecast" class="text-sm font-medium">預測期數：</label><select id="monthsToForecast" class="form-select w-full md:w-auto px-3 py-1.5 text-sm"><option value="3">3 個月</option><option value="6" selected>6 個月</option><option value="12">12 個月</option></select><button id="runFutureForecast" class="bg-green-600 text-white py-1.5 px-4 rounded-md font-semibold hover:bg-green-700 transition text-sm">開始預測</button></div></div>
                        <div id="futureForecastSection" class="hidden"><div class="h-80 mb-6"><canvas id="futurePredictionChart"></canvas></div><div class="overflow-x-auto max-h-60"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50 sticky top-0"><tr><th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">預測月份</th><th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">預測 S&P 500 指數</th></tr></thead><tbody id="futurePredictionTableBody" class="bg-white divide-y divide-gray-200"></tbody></table></div></div>
                        <div id="forecast-placeholder" class="text-center py-20"><svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg><h3 class="mt-2 text-sm font-medium text-gray-900">尚未進行預測</h3><p class="mt-1 text-sm text-gray-500">點擊「開始預測」以生成圖表。</p></div>
                    </div>
                </div>
            </div>
            <div id="data-management" class="content-page">
                 <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-gray-800">數據管理</h2>
                    <label class="bg-blue-500 text-white py-2 px-4 rounded-md font-semibold hover:bg-blue-600 transition cursor-pointer flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                        上傳 CSV
                        <input type="file" id="csv-upload-input" class="hidden" accept=".csv">
                    </label>
                </div>
                <div class="card p-0"><div class="overflow-x-auto max-h-[75vh]"><table class="min-w-full divide-y divide-gray-200"><thead id="data-table-head" class="bg-gray-50 sticky top-0"></thead><tbody id="data-table-body" class="bg-white divide-y divide-gray-200"></tbody></table></div></div>
            </div>
            <div id="model-settings" class="content-page">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">模型設定</h2><div class="card p-6 max-w-2xl mx-auto"><h3 class="text-xl font-bold mb-4">當前使用模型</h3><div class="space-y-4"><div><span class="font-semibold text-gray-700 w-32 inline-block">模型類型:</span><span class="text-gray-900">支持向量回歸 (SVR)</span></div><div><span class="font-semibold text-gray-700 w-32 inline-block">模型版本:</span><span class="text-gray-900 bg-gray-100 px-2 py-1 rounded">SVR-v1.2</span></div><div><span class="font-semibold text-gray-700 w-32 inline-block">核心 (Kernel):</span><span class="text-gray-900">徑向基函數 (rbf)</span></div></div><h3 class="text-xl font-bold mt-8 mb-4">最佳化參數 (GridSearchCV)</h3><div class="space-y-4"><div><span class="font-semibold text-gray-700 w-32 inline-block">C (懲罰參數):</span><span class="text-gray-900">10</span></div><div><span class="font-semibold text-gray-700 w-32 inline-block">Gamma:</span><span class="text-gray-900">0.1</span></div><div><span class="font-semibold text-gray-700 w-32 inline-block">Epsilon:</span><span class="text-gray-900">0.1</span></div></div><div class="mt-8 border-t pt-6"><button class="w-full bg-indigo-600 text-white py-2.5 px-4 rounded-md font-semibold hover:bg-indigo-700 transition">觸發模型重新訓練</button><p class="text-xs text-gray-500 mt-2 text-center">注意：重新訓練可能需要數分鐘時間，並會消耗大量計算資源。</p></div></div>
            </div>
            <div id="reports" class="content-page">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">報告中心</h2><div class="card p-6 max-w-2xl mx-auto"><h3 class="text-xl font-bold mb-4">生成預測報告</h3><p class="text-sm text-gray-600 mb-6">選擇時間範圍與格式，以生成包含圖表與數據的完整報告。</p><div class="space-y-4"><div><label for="report-range" class="block text-sm font-medium text-gray-700">報告時間範圍</label><select id="report-range" class="form-select mt-1 block w-full p-2"><option>下個月</option><option>下一季度</option><option>下半年</option></select></div><div class="flex gap-4"><button id="generate-pdf-btn" class="flex-1 bg-red-600 text-white py-2.5 px-4 rounded-md font-semibold hover:bg-red-700 transition flex items-center justify-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>生成 PDF 報告</button><button id="download-csv-btn" class="flex-1 bg-green-600 text-white py-2.5 px-4 rounded-md font-semibold hover:bg-green-700 transition flex items-center justify-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M2 5a2 2 0 012-2h12a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2V5zm2 1v2h12V6H4zm0 4v2h12v-2H4zm0 4v2h12v-2H4z" /></svg>下載 CSV 數據</button></div></div></div>
            </div>
        </main>
    </div>

    
    <div id="notification-container" class="notification-container"></div>
    
    <footer class="lg:hidden fixed bottom-0 left-0 right-0 z-40 bg-white border-t border-gray-200">
        <div class="flex justify-around items-center p-1">
            <a href="#model-settings" class="nav-link mobile-nav-link"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01-.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" /></svg><span class="text-xs mt-1">模型設定</span></a>
            <a href="#data-management" class="nav-link mobile-nav-link"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z" /></svg><span class="text-xs mt-1">數據管理</span></a>
            <a href="#reports" class="nav-link mobile-nav-link"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg><span class="text-xs mt-1">報告中心</span></a>
        </div>
    </footer>

    
    <div id="indicator-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-title" class="text-xl font-bold">指標詳情</h3>
                <button id="modal-close-btn" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <div class="h-80">
                <canvas id="modal-chart"></canvas>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Global Data and Variables ---
        let historicalData = [ { date: '2024-02', y_t: 5096.27, t_1: 4958.61, t_2: 4845.65, dollar_index: 104.14, us_10y_yield: 4.25, us_2y_yield: 4.64, unemployment: 3.9, cpi: 3.2, pmi: 47.8, vix: 13.73, nfp: 275, ffr: 5.33, gold: 2325.0 }, { date: '2024-03', y_t: 5254.35, t_1: 5096.27, t_2: 4958.61, dollar_index: 104.52, us_10y_yield: 4.2, us_2y_yield: 4.62, unemployment: 3.8, cpi: 3.5, pmi: 50.3, vix: 13.01, nfp: 303, ffr: 5.33, gold: 2257.8 }, { date: '2024-04', y_t: 5035.69, t_1: 5254.35, t_2: 5096.27, dollar_index: 105.73, us_10y_yield: 4.68, us_2y_yield: 5.04, unemployment: 3.9, cpi: 3.4, pmi: 49.2, vix: 15.33, nfp: 175, ffr: 5.33, gold: 2307.2 }, { date: '2024-05', y_t: 5277.51, t_1: 5035.69, t_2: 5254.35, dollar_index: 104.66, us_10y_yield: 4.51, us_2y_yield: 4.93, unemployment: 4.0, cpi: 3.3, pmi: 48.7, vix: 14.47, nfp: 272, ffr: 5.33, gold: 2347.4 }, { date: '2024-06', y_t: 5460.48, t_1: 5277.51, t_2: 5035.69, dollar_index: 105.91, us_10y_yield: 4.39, us_2y_yield: 4.87, unemployment: 4.0, cpi: 3.3, pmi: 51.1, vix: 13.2, nfp: 272, ffr: 5.33, gold: 2325.0 }, { date: '2024-07', y_t: 5439.68, t_1: 5460.48, t_2: 5277.51, dollar_index: 105.82, us_10y_yield: 4.34, us_2y_yield: 4.85, unemployment: 4.0, cpi: 3.0, pmi: 51.5, vix: 12.98, nfp: 200, ffr: 5.33, gold: 2330.1 }, { date: '2024-08', y_t: 5450.51, t_1: 5439.68, t_2: 5460.48, dollar_index: 105.65, us_10y_yield: 4.25, us_2y_yield: 4.75, unemployment: 3.9, cpi: 3.1, pmi: 51.2, vix: 12.5, nfp: 180, ffr: 5.33, gold: 2345.6 }, { date: '2024-09', y_t: 5329.93, t_1: 5450.51, t_2: 5439.68, dollar_index: 106.21, us_10y_yield: 4.41, us_2y_yield: 4.89, unemployment: 4.1, cpi: 3.2, pmi: 49.8, vix: 14.8, nfp: 165, ffr: 5.33, gold: 2301.2 }, { date: '2024-10', y_t: 5048.42, t_1: 5329.93, t_2: 5450.51, dollar_index: 107.1, us_10y_yield: 4.65, us_2y_yield: 5.01, unemployment: 4.2, cpi: 3.3, pmi: 49.1, vix: 18.2, nfp: 150, ffr: 5.33, gold: 2280.5 }, { date: '2024-11', y_t: 5137.94, t_1: 5048.42, t_2: 5329.93, dollar_index: 105.5, us_10y_yield: 4.35, us_2y_yield: 4.8, unemployment: 4.1, cpi: 3.1, pmi: 50.2, vix: 15.5, nfp: 190, ffr: 5.33, gold: 2315.8 }, { date: '2024-12', y_t: 5051.57, t_1: 5137.94, t_2: 5048.42, dollar_index: 104.9, us_10y_yield: 4.22, us_2y_yield: 4.7, unemployment: 4.0, cpi: 3.0, pmi: 50.6, vix: 14.1, nfp: 210, ffr: 5.33, gold: 2350.0 }, { date: '2025-01', y_t: 5123.69, t_1: 5051.57, t_2: 5137.94, dollar_index: 105.2, us_10y_yield: 4.25, us_2y_yield: 4.73, unemployment: 4.0, cpi: 3.3, pmi: 48.7, vix: 13.2, nfp: 272, ffr: 5.33, gold: 2325.0 } ];
        let latestForecastResults = []; 
        let latestInitialInputs = {};
        const dashboardIndicatorNames = {
            'y_t': 'S&P 500 指數',
            'Us_Dollar_Index': '美元指數',
            'US10YY': '十年期公債殖利率',
            'US2YY': '二年期公債殖利率',
            'Unemployment_Rate': '失業率',
            'CPI': '消費者物價指數CPI',
            'PMI_Index': '採購經理人指數PMI',
            'VIX_Index': 'VIX恐慌指數',
            'Nfarm': '非農就業人口 (千人)',
            'EFFR': '聯準會基本利率FFR',
            'gold': '黃金價格'
        };
        const modelFeatureNames = {
            't_1': 'S&P 500 前一期 (t-1)',
            't_2': 'S&P 500 前二期 (t-2)',
            'Us_Dollar_Index': '美元指數',
            'US10YY': '十年期公債殖利率',
            'US2YY': '二年期公債殖利率',
            'Unemployment_Rate': '失業率',
            'CPI': '消費者物價指數CPI',
            'PMI_Index': '採購經理人指數PMI',
            'VIX_Index': 'VIX恐慌指數',
            'EFFR': '聯準會基本利率FFR',
            'gold': '黃金價格',
            'Nfarm': '非農就業人口 (千人)'
        };
        const featureOrder = [
            't_1', 't_2',
            'Us_Dollar_Index', 'US10YY', 'US2YY',
            'Unemployment_Rate', 'CPI', 'PMI_Index',
            'VIX_Index', 'EFFR', 'gold', 'Nfarm'
        ];
        const indicatorUnits = {
            'US10YY': '%',
            'US2YY': '%',
            'Unemployment_Rate': '%',
            'CPI': '%',
            'EFFR': '%'
        };
        const initializedPages = new Set();
        let chartInstances = {};

        // --- Helper Functions ---
        function createChart(ctx, chartInstance, type, data, options) {
            if (chartInstance) chartInstance.destroy();
            return new Chart(ctx, { type, data, options });
        }

        async function callGeminiAPI(prompt) {
            try {
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const result = await response.json();
                if (result.candidates && result.candidates[0].content.parts[0].text) {
                    return result.candidates[0].content.parts[0].text;
                }
                throw new Error('Invalid API response structure');
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                return "抱歉，連接分析服務時發生錯誤。";
            }
        }
        
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            container.appendChild(notification);
            container.classList.add('show');
            setTimeout(() => {
                container.classList.remove('show');
                setTimeout(() => container.removeChild(notification), 300);
            }, 3000);
        }

        function downloadCSV(data, filename = 'data.csv') {
            if (!data || data.length === 0) {
                showNotification('沒有可下載的數據。', 'error');
                return;
            }
            // 防呆：產生月份時 fallback
            let lastYear = 2025, lastMonth = 1;
            if (historicalData.at(-1) && historicalData.at(-1).date && typeof historicalData.at(-1).date === 'string') {
                const [y, m] = historicalData.at(-1).date.split('-').map(Number);
                if (!isNaN(y) && !isNaN(m)) {
                    lastYear = y;
                    lastMonth = m;
                }
            }
            const headers = Object.keys(data[0]);
            const csvRows = [
                headers.join(','),
                ...data.map(row => headers.map(header => JSON.stringify(row[header])).join(','))
            ];
            const csvString = csvRows.join('\n');
            const blob = new Blob([`\uFEFF${csvString}`], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        async function generatePDFReport() {
            if (latestForecastResults.length === 0) {
                showNotification('請先在「模型預測」頁面生成一次預測。', 'info');
                return;
            }
            showNotification('正在生成 PDF 報告...', 'info');
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            // 防呆：產生月份時 fallback
            let lastYear = 2025, lastMonth = 1;
            if (historicalData.at(-1) && historicalData.at(-1).date && typeof historicalData.at(-1).date === 'string') {
                const [y, m] = historicalData.at(-1).date.split('-').map(Number);
                if (!isNaN(y) && !isNaN(m)) {
                    lastYear = y;
                    lastMonth = m;
                }
            }
            doc.setFont('helvetica', 'bold');
            doc.text('S&P 500 AI Strategy Report', 105, 20, null, null, 'center');
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.text(`Report Generated: ${new Date().toLocaleString('en-CA')}`, 105, 28, null, null, 'center');

            doc.setFontSize(12);
            doc.text('Market Signal: Bullish', 20, 40);
            doc.text(`Current VIX: ${latestInitialInputs.vix || 'N/A'}`, 20, 48);

            doc.setFontSize(16);
            doc.text('Forecast Chart', 20, 65);
            const chartCanvas = document.getElementById('futurePredictionChart');
            const chartImage = chartCanvas.toDataURL('image/png', 1.0);
            doc.addImage(chartImage, 'PNG', 15, 70, 180, 90);
            
            const tableBody = latestForecastResults.map((value, i) => {
                const lastHistoryDate = new Date(historicalData[historicalData.length - 1].date + "-01");
                const forecastDate = new Date(lastHistoryDate);
                forecastDate.setMonth(lastHistoryDate.getMonth() + i + 1);
                return [
                    forecastDate.toLocaleDateString('en-CA', { year: 'numeric', month: '2-digit' }),
                    value.toLocaleString('en-US')
                ];
            });

            doc.autoTable({
                head: [['Month', 'Predicted S&P 500']],
                body: tableBody,
                startY: 170,
                headStyles: { fillColor: [59, 130, 246] },
            });
            
            doc.save('sp500-ai-report.pdf');
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file || !file.name.endsWith('.csv')) {
                showNotification('請選擇一個 .csv 檔案。', 'error');
                return;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    const rows = text.split(/[\r\n]+/).filter(row => row.trim() !== '');
                    if (rows.length < 2) throw new Error('CSV 檔案為空或格式不正確。');
                    
                    const headers = rows.shift().trim().split(',');
                    const requiredHeaders = Object.keys(historicalData[0]);
                    if (!requiredHeaders.every(h => headers.includes(h))) {
                        throw new Error(`CSV 缺少必要的欄位。需要: ${requiredHeaders.join(', ')}`);
                    }

                    const newData = rows.map(row => {
                        const values = row.trim().split(',');
                        let obj = {};
                        headers.forEach((header, i) => {
                            const value = values[i];
                            obj[header] = !isNaN(parseFloat(value)) ? parseFloat(value) : value;
                        });
                        return obj;
                    });
                    
                    historicalData = newData;
                    initDataManagement(true); // Re-render the table
                    renderIndicatorCards(); // Update dashboard cards
                    showNotification('數據上傳並更新成功！', 'success');
                } catch (error) {
                    console.error("CSV Parsing Error:", error);
                    showNotification(`CSV 解析失敗: ${error.message}`, 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }


        // --- SPA Navigation & Initialization ---
        const navLinks = document.querySelectorAll('.nav-link');
        const contentPages = document.querySelectorAll('.content-page');
        
        function initPage(pageId) {
            if (initializedPages.has(pageId)) return;
            switch (pageId) {
                case 'dashboard': initDashboard(); break;
                case 'qa-robot': initQARobot(); break;
                case 'monthly-forecast': initMonthlyForecast(); break;
                case 'data-management': initDataManagement(false); break;
                case 'reports': initReports(); break;
            }
            initializedPages.add(pageId);
        }

        function navigateTo(hash) {
            const targetHash = hash || '#dashboard';
            navLinks.forEach(link => link.classList.toggle('active', link.getAttribute('href') === targetHash));
            contentPages.forEach(page => {
                const isActive = '#' + page.id === targetHash;
                page.classList.toggle('active', isActive);
                if (isActive) initPage(page.id);
            });
        }

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const hash = e.currentTarget.getAttribute('href');
                if (window.location.hash !== hash) window.history.pushState(null, null, hash);
                navigateTo(hash);
            });
        });
        
        window.addEventListener('hashchange', () => navigateTo(window.location.hash));
        navigateTo(window.location.hash || '#dashboard');

        // --- Page-Specific Initializers ---

        function initDashboard() { 
            const backtestCtx = document.getElementById('backtestChart').getContext('2d');
            const backtestData = { labels: Array.from({length: 12}, (_, i) => `2024-${i+1}`), datasets: [ { label: 'AI 模型 + 篩選', data: [100, 105, 108, 112, 115, 118, 122, 125, 128, 132, 135, 140], borderColor: '#16a34a', borderWidth: 3, tension: 0.1, pointRadius: 0 }, { label: '模型擇時', data: [100, 102, 104, 103, 106, 108, 110, 109, 112, 115, 116, 119], borderColor: '#3b82f6', borderWidth: 2, tension: 0.1, pointRadius: 0 }, { label: '買入並持有 S&P 500', data: [100, 101, 103, 100, 104, 105, 107, 104, 106, 109, 108, 112], borderColor: '#9ca3af', borderWidth: 2, tension: 0.1, pointRadius: 0, borderDash: [5, 5] } ] };
            const backtestOptions = { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } }, scales: { y: { title: { display: true, text: '模擬投資組合價值' } } } };
            chartInstances.backtestChart = createChart(backtestCtx, chartInstances.backtestChart, 'line', backtestData, backtestOptions);
            
            renderIndicatorCards();

            const generateSummaryBtn = document.getElementById('generate-summary-btn');
            const marketFocusContent = document.getElementById('market-focus-content');
            generateSummaryBtn.addEventListener('click', async () => {
                marketFocusContent.innerHTML = '<p class="text-sm text-gray-500 animate-pulse">✨ 正在為您生成市場焦點分析...</p>';
                generateSummaryBtn.disabled = true;
                const prompt = `您是一位頂尖的金融市場分析師。請以繁體中文，為一位專業投資人總結今天最重要的市場焦點。您的分析應包含：1. **宏觀經濟:** 最新的關鍵經濟數據（如CPI, 就業報告）及其可能影響。2. **行業動態:** 特別是科技與半導體行業の重大新聞或趨勢。3. **分析師評級:** 任何知名分析師對重要公司或行業的評級變動。請以條列式、簡潔有力的方式呈現，並在最後給出一個總結性的「AI洞察」。`;
                const text = await callGeminiAPI(prompt);
                const lines = text.split('\n').filter(line => line.trim() !== '*' && line.trim() !== '');
                let html = lines.map(line => {
                    const trimmedLine = line.trim();
                    if (trimmedLine.startsWith('**') && trimmedLine.endsWith('**')) return `<p class="text-sm font-bold text-gray-800 mt-3">${trimmedLine.substring(2, trimmedLine.length - 2)}</p>`;
                    if (/^\d\.\s/.test(trimmedLine)) return `<p class="text-sm font-semibold text-gray-700 mt-2">${trimmedLine}</p>`;
                    if (trimmedLine.startsWith('- ') || trimmedLine.startsWith('* ')) return `<p class="text-xs text-gray-600 mt-1 pl-2">&bull; ${trimmedLine.substring(2)}</p>`;
                    return `<p class="text-xs text-gray-600 mt-1">${trimmedLine}</p>`;
                }).join('');
                marketFocusContent.innerHTML = html;
                generateSummaryBtn.disabled = false;
            });
        }
        
        function renderIndicatorCards() {
            const indicatorGrid = document.getElementById('indicator-grid');
            const modal = document.getElementById('indicator-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalCloseBtn = document.getElementById('modal-close-btn');
            indicatorGrid.innerHTML = '';
            Object.keys(dashboardIndicatorNames).forEach(key => {
                const card = document.createElement('div');
                card.className = 'indicator-card card p-4 group border border-gray-200';
                card.dataset.indicatorKey = key;
                let latestValue = historicalData[historicalData.length - 1][key];
                const unit = indicatorUnits[key] || '';
                if (latestValue === undefined || latestValue === null || latestValue === '') latestValue = '-';
                card.innerHTML = `<div class="flex justify-between items-start"><div><p class="text-sm font-medium text-gray-500">${dashboardIndicatorNames[key]}</p><p class="text-2xl font-bold text-gray-800 mt-1">${latestValue}${unit}</p></div><div class="bg-gray-100 group-hover:bg-blue-100 rounded-full p-1.5 transition-colors duration-200"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 group-hover:text-blue-600 transition-colors duration-200" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 7l5 5m0 0l-5 5m5-5H6" /></svg></div></div>`;
                indicatorGrid.appendChild(card);
                card.addEventListener('click', () => {
                    const indicatorKey = card.dataset.indicatorKey;
                    modalTitle.textContent = dashboardIndicatorNames[indicatorKey];
                    const modalChartCtx = document.getElementById('modal-chart').getContext('2d');
                    // 曲線圖資料
                    const chartLabels = historicalData.map(d => d.date || '');
                    const chartData = historicalData.map(d => d[indicatorKey]);
                    // 若全為 undefined/null/空，顯示無資料
                    const allEmpty = chartData.every(v => v === undefined || v === null || v === '');
                    const datasets = allEmpty ? [] : [{ label: dashboardIndicatorNames[indicatorKey], data: chartData, borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', borderWidth: 2, tension: 0.1, fill: true }];
                    chartInstances.modalChart = createChart(modalChartCtx, chartInstances.modalChart, 'line', { labels: chartLabels, datasets }, { responsive: true, maintainAspectRatio: false });
                    modal.classList.add('active');
                });
            });
            modalCloseBtn.addEventListener('click', () => modal.classList.remove('active'));
            modal.addEventListener('click', (e) => { if (e.target === modal) modal.classList.remove('active'); });
        }

        const PREDICT_API_URL = "https://my-vertex-proxy-1095766716155.asia-east1.run.app/predict";

        // Helper to safely parse float values, handling potential object wrappers or non-numeric inputs
        function safeParseFloat(val) {
            if (typeof val === 'object' && val !== null) {
                if (val.value !== undefined) return parseFloat(val.value);
                if (Array.isArray(val) && val.length === 1) return parseFloat(val[0]);
                return NaN;
            }
            return parseFloat(val);
        }

        async function fetchPredict(cur) {
            const payload = {
                t_1: safeParseFloat(cur.t_1),
                t_2: safeParseFloat(cur.t_2),
                Us_Dollar_Index: safeParseFloat(cur.Us_Dollar_Index),
                US10YY: safeParseFloat(cur.US10YY),
                US2YY: safeParseFloat(cur.US2YY),
                Unemployment_Rate: safeParseFloat(cur.Unemployment_Rate),
                CPI: safeParseFloat(cur.CPI),
                PMI_Index: safeParseFloat(cur.PMI_Index),
                VIX_Index: safeParseFloat(cur.VIX_Index),
                EFFR: safeParseFloat(cur.EFFR),
                gold: safeParseFloat(cur.gold),
                Nfarm: safeParseFloat(cur.Nfarm)
            };

            // 檢查所有欄位都是純數字
            for (const key in payload) {
                if (isNaN(payload[key])) {
                    throw new Error(`Input data for prediction contains non-numeric value for ${key}.`);
                }
            }

            // Debug: 輸出送出前的 payload
            console.log('送出 Vertex AI payload:', JSON.stringify(payload));

            const resp = await fetch(PREDICT_API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ instances: [payload] })
            });

            const data = await resp.json();
            if (!data || !data.predictions || !Array.isArray(data.predictions) || data.predictions.length === 0) {
                throw new Error('Invalid prediction response from API: ' + JSON.stringify(data));
            }

            let predictionResult = data.predictions[0];
            if (typeof predictionResult === 'object' && predictionResult !== null && predictionResult.value !== undefined) {
                predictionResult = predictionResult.value;
            } else if (Array.isArray(predictionResult) && predictionResult.length === 1) {
                predictionResult = predictionResult[0];
            }

            const finalPrediction = parseFloat(predictionResult);
            if (isNaN(finalPrediction)) {
                throw new Error('Prediction result is not a valid number: ' + JSON.stringify(data.predictions[0]));
            }
            return finalPrediction;
        }

        function renderForecastChart() {
            const tbody = document.getElementById('futurePredictionTableBody');
            const section = document.getElementById('futureForecastSection');
            const placeholder = document.getElementById('forecast-placeholder');
            tbody.innerHTML = '';
            // 取得最後一筆資料的年月，若無 date 欄位則 fallback
            let lastYear = 2025, lastMonth = 1; // 預設 fallback
            if (historicalData.at(-1) && historicalData.at(-1).date && typeof historicalData.at(-1).date === 'string') {
                const [y, m] = historicalData.at(-1).date.split('-').map(Number);
                if (!isNaN(y) && !isNaN(m)) {
                    lastYear = y;
                    lastMonth = m;
                }
            }
            const labels = [], data = [latestInitialInputs.t_1]; // Start chart data with the initial S&P 500 value
            latestForecastResults.forEach((v, i) => {
                let year = lastYear;
                let month = lastMonth + i + 1;
                while (month > 12) {
                    year += 1;
                    month -= 12;
                }
                const forecastMonth = `${year}/${month.toString().padStart(2, '0')}`;
                labels.push(forecastMonth);
                data.push(v);
                tbody.insertAdjacentHTML('beforeend',
                    `<tr><td class="px-4 py-3 text-sm">${forecastMonth}</td><td class="px-4 py-3 text-sm">${v.toLocaleString('en-US')}</td></tr>`);
            });
            const ctx = document.getElementById('futurePredictionChart').getContext('2d');
            chartInstances.futureChart = createChart(ctx, chartInstances.futureChart, 'line', {
                labels, datasets:[{label:'S&P 500 預測走勢',data,borderColor:'#16a34a',backgroundColor:'rgba(22,163,74,0.1)',fill:true,tension:0.3}]
            }, {responsive:true,maintainAspectRatio:false,scales:{x:{type:'category'}}});
            placeholder.classList.add('hidden');
            section.classList.remove('hidden');
        }

        function initMonthlyForecast() {
            const form = document.getElementById('predictionForm');
            const runBtn = document.getElementById('runFutureForecast');

            // －－把 historicalData 的欄位名稱 → 轉成模型欄位－－
            const KEY_ALIAS = {
                dollar_index:        'Us_Dollar_Index',
                us_10y_yield:        'US10YY',
                us_2y_yield:         'US2YY',
                unemployment:        'Unemployment_Rate',
                cpi:                 'CPI',
                pmi:                 'PMI_Index',
                vix:                 'VIX_Index',
                nfp:                 'Nfarm',
                ffr:                 'EFFR',
                gold:                'gold',
                y_t:                 'y_t',
                t_1:                 't_1',
                t_2:                 't_2'
            };
            // 讓 defaults 先改成「正確鍵名」的物件
            const lastRowRaw = historicalData.at(-1);
            const defaults = {};
            Object.keys(lastRowRaw).forEach(k => {
                const stdKey = KEY_ALIAS[k] || k;
                defaults[stdKey] = lastRowRaw[k];
            });

            form.innerHTML = '';
            featureOrder.forEach(k => {
                const value = (defaults[k] !== undefined && defaults[k] !== null && defaults[k] !== '') ? defaults[k] : 0;
                form.insertAdjacentHTML('beforeend',
                    `<div><label for="input-${k}" class="block text-xs font-medium text-gray-600">${modelFeatureNames[k] || k}</label><input type="number" id="input-${k}" step="any" name="${k}" class="form-input mt-1 block w-full px-2 py-1.5 text-sm" value="${value}"></div>`);
            });

            const MACRO_KEYS = [
                'Us_Dollar_Index', 'US10YY', 'US2YY', 'Unemployment_Rate',
                'CPI', 'PMI_Index', 'VIX_Index', 'EFFR', 'gold', 'Nfarm'
            ];

            runBtn.addEventListener('click', async () => {
                const formData = new FormData(form);
                const init = {};
                let missing = [];
                for (let [k,v] of formData.entries()) {
                    // Ensure all initial inputs are numbers
                    const parsedValue = parseFloat(v);
                    if (isNaN(parsedValue)) {
                        missing.push(modelFeatureNames[k] || k);
                    }
                    init[k] = parsedValue;
                }
                if (missing.length > 0) {
                    showNotification('請填寫所有有效的初始數值：' + missing.join('、'), 'error');
                    return;
                }
                latestInitialInputs = { ...init };
                latestForecastResults = [];
                const months = +document.getElementById('monthsToForecast').value;
                let cur = { ...init };
                // 取預測起始月（1月）的 macro features
                const macroBase = {};
                MACRO_KEYS.forEach(k => macroBase[k] = parseFloat(cur[k]));
                showNotification('正在向 AI 模型請求預測...','info');
                runBtn.disabled = true;

                try {
                    for (let i=0; i<months; i++) {
                        // Ensure all current values in 'cur' are numbers before sending to fetchPredict
                        Object.keys(cur).forEach(k => {
                            cur[k] = safeParseFloat(cur[k]);
                            if (isNaN(cur[k])) {
                                throw new Error(`Internal error: Non-numeric value found in 'cur' object for key: ${k}`);
                            }
                        });

                        const pred = await fetchPredict(cur); // pred is now guaranteed to be a number
                        
                        // Check for NaN prediction before using it
                        if (isNaN(pred)) {
                            showNotification('模型返回了無效的預測值 (NaN)。請檢查輸入數據或模型。', 'error');
                            break; // Stop forecasting if an invalid prediction occurs
                        }

                        latestForecastResults.push(pred);
                        
                        // ① 更新 lag 變數
                        cur.t_2 = cur.t_1; // cur.t_1 is already a number
                        cur.t_1 = pred; // pred is already a number
                        
                        // ② macro features 緩慢往 1月的值靠攏（90% 當前 + 10% 1月），確保都是數字
                        MACRO_KEYS.forEach(k => {
                            cur[k] = parseFloat(cur[k]) * 0.9 + parseFloat(macroBase[k]) * 0.1;
                        });
                    }
                    renderForecastChart();
                    showNotification('模型預測完成！','success');
                } catch(err) {
                    console.error(err);
                    showNotification('呼叫 API 失敗：'+err.message,'error');
                } finally {
                    runBtn.disabled = false;
                }
            });
        }

        function initDataManagement(isUpdate = false) { 
            const tableHead = document.getElementById('data-table-head');
            const tableBody = document.getElementById('data-table-body');
            const uploadInput = document.getElementById('csv-upload-input');
            if (!tableHead || !tableBody || !uploadInput) return;
            const headers = Object.keys(historicalData[0]);
            let headHtml = '<tr>';
            headers.forEach(h => headHtml += `<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${h.replace(/_/g, ' ')}</th>`);
            headHtml += '</tr>';
            tableHead.innerHTML = headHtml;
            let bodyHtml = '';
            // 修正：由下往上顯示（最新資料在最上面）
            historicalData.slice().reverse().forEach(row => {
                bodyHtml += '<tr>';
                headers.forEach(h => bodyHtml += `<td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${row[h]}</td>`);
                bodyHtml += '</tr>';
            });
            tableBody.innerHTML = bodyHtml;
            if (!isUpdate) {
                uploadInput.addEventListener('change', handleFileUpload);
            }
        }
        
        function initReports() {
            const downloadCsvBtn = document.getElementById('download-csv-btn');
            const generatePdfBtn = document.getElementById('generate-pdf-btn');
            
            downloadCsvBtn.addEventListener('click', () => {
                if (latestForecastResults.length === 0) {
                    showNotification('請先在「模型預測」頁面生成一次預測。', 'info');
                    return;
                }
                const dataToDownload = latestForecastResults.map((value, i) => {
                     const lastHistoryDate = new Date(historicalData[historicalData.length - 1].date + "-01");
                     const forecastDate = new Date(lastHistoryDate);
                     forecastDate.setMonth(lastHistoryDate.getMonth() + i + 1);
                     return {
                        month: forecastDate.toLocaleDateString('en-CA', { year: 'numeric', month: '2-digit' }),
                        predicted_sp500: value
                     }
                });
                downloadCSV(dataToDownload, 'sp500_forecast.csv');
            });

            generatePdfBtn.addEventListener('click', generatePDFReport);
        }

        function initQARobot() {
            const chatWindow = document.getElementById('chat-window');
            const chatForm = document.getElementById('chat-form');
            const chatInput = document.getElementById('chat-input');
            const quickQuestionBtns = document.querySelectorAll('.quick-question-btn');

            const addMessage = (message, sender, isLoading = false) => {
                const bubble = document.createElement('div');
                bubble.className = `w-full max-w-xl p-4 prose prose-sm ${sender === 'user' ? 'chat-bubble-user self-end' : 'chat-bubble-bot self-start'}`;
                if (isLoading) bubble.id = 'loading-bubble';
                bubble.innerHTML = message;
                chatWindow.appendChild(bubble);
                chatWindow.scrollTop = chatWindow.scrollHeight;
            };

            const handleQuestion = async (question) => {
                addMessage(`<p>${question}</p>`, 'user');
                chatInput.value = '';
                addMessage('<div class="flex items-center gap-2"><div class="w-2 h-2 bg-gray-500 rounded-full animate-pulse"></div><div class="w-2 h-2 bg-gray-500 rounded-full animate-pulse [animation-delay:0.2s]"></div><div class="w-2 h-2 bg-gray-500 rounded-full animate-pulse [animation-delay:0.4s]"></div><p>正在為您分析中...</p></div>', 'bot', true);
                const trendText = "溫和看漲";
                const vix = latestInitialInputs.vix || 13.2;
                const prompt = `您是一位專業的AI投資策略顧問。您的任務是基於以下的市場宏觀預測，為用戶提供關於長期投資的分析。請用繁體中文回答。**當前市場宏觀背景:** - S&P 500 預測趨勢: ${trendText} - VIX 恐慌指數: ${vix} **用戶問題:** "${question}" **您的回答應遵循以下結構:** 1. **宏觀分析:** 首先重申當前的市場宏觀趨勢。2. **具體分析:** 針對用戶的問題（個股、產業或策略），結合宏觀背景和您的知識庫進行深入分析。對於個股或產業，請提及長期的增長驅動力和潛在風險。3. **結論:** 給出一個總結性的看法。4. **免責聲明:** 最後必須加上免責聲明。請開始您的分析：`;
                const botResponseText = await callGeminiAPI(prompt);
                const loadingBubble = document.getElementById('loading-bubble');
                if (loadingBubble) loadingBubble.remove();
                addMessage(botResponseText.replace(/\n/g, '<br>'), 'bot');
            };

            chatForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const question = chatInput.value.trim();
                if (question) handleQuestion(question);
            });
            quickQuestionBtns.forEach(btn => {
                btn.addEventListener('click', () => handleQuestion(btn.textContent));
            });
            chatWindow.innerHTML = ''; 
            addMessage("您好！我是您的 AI 投資策略顧問 (由 Gemini 驅動)。您可以問我關於 S&P 500 趨勢、特定公司或行業的長期投資看法。", 'bot');
        }

        const csvUrl = 'https://raw.githubusercontent.com/leonyu5566/sp500-ai-advisor/refs/heads/main/120%E6%9C%9F%E8%B3%87%E6%96%99%20-%20SVR%2012%E8%87%AA%E8%AE%8A%E6%95%B8%20(2).csv';
        fetch(csvUrl)
          .then(response => response.text())
          .then(csvText => {
            Papa.parse(csvText, {
              header: true,
              dynamicTyping: true,
              skipEmptyLines: true,
              complete: function(results) {
                // 強制 key 完全照 CSV 標題
                const csvHeader = results.meta.fields.map(h => h.trim());
                results.data = results.data.map(row => {
                  const newRow = {};
                  csvHeader.forEach(h => {
                    newRow[h] = row[h];
                  });
                  return newRow;
                });
                historicalData = results.data;
                if (typeof initDataManagement === 'function') initDataManagement(true);
                if (typeof renderIndicatorCards === 'function') renderIndicatorCards();
                if (typeof initMonthlyForecast === 'function') initMonthlyForecast();
              }
            });
          });
    });
    </script>
</body>
</html>







